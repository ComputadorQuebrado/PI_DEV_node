<main class="container">
    <form action="/cadReserva/reservar" method="POST">
        <div class="form-row">
            <div class="form-group col-md-4" style="margin-bottom: 0px;">
                <label>ID da chave</label>
                <p name="id_chave">{{chave.titulo}}</p>
                <input type="hidden" name="fk_chave" value="{{chave.id_chave}}">
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-8">
                <label>Código</label>
                <select name="fk_usuario" id="idusuario" class="form-control">
                    {{#if tb_usuario.length}}
                        {{#each tb_usuario}}
                            <option value={{this.id_usuario}}>{{this.nome}} - {{this.prontuario}}</option>
                        {{/each}}
                    {{else}}
                        <option value="NA">Sem usuários disponíveis.</option>
                    {{/if}}
                </select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group col-md-4">
                <label for="dt_planejada">Data</label>
                <input type="datetime-local" class="form-control" name="dt_planejada" id="dt_planejada" oninput="copiarEntrada()">
            </div>
            <div class="form-group col-md-4">
                <label for="dt_planejadafinal">Hora de retorno:</label>
                <input type="datetime-local" class="form-control" name="dt_planejadafinal" id="dt_planejadafinal">
            </div>
        </div>
        <button type="button" class="btn btn-secondary btn-sm" id="btnCancelar">CANCELAR</button>
        <button type="button" class="btn btn-primary btn-sm" id="btnGravar" onclick="verificarConflitoReserva()">GRAVAR</button>
    </form>
    <div class="form-row">
        <div class="form-group col-md-10">
            <label>Próximas Reservas</label>
            <div class="container">
                {{#if tb_reserva.length}}
                    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                    {{#each tb_reserva}}
                        <div class="col">
                            <div class="card h-100 bg-light border-primary">
                                <div class="card-body" style="padding: 15px;">
                                    <p class="card-title text-primary">
                                        {{this.id_reserva}} 
                                        <button class="btn btn-danger btn-sm" 
                                                onclick="confirmarApagar('/cadReserva/{{this.id_reserva}}/desativar')">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </p>
                                    <p class="card-text">
                                        <span>Início: </span><span class="card-text" name="card_dt_planejada" id="card_dt_planejada">{{formatDateTime this.dt_planejada}}</span>
                                        <span><br>Fim: </span><span class="card-text" name="card_dt_planejadafinal" id="card_dt_planejadafinal">{{formatDateTime this.dt_planejadafinal}}</span>
                                        <span><br>Reservada em: </span><span class="card-text" name="card_dt_reserva" id="card_dt_reserva">{{formatDate this.dt_reserva}}</span>
                                    </p>
                                </div>
                            </div>
                        </div>
                    {{/each}}
                    </div>
                {{else}}
                    <div class="alert alert-warning text-center" role="alert">
                    Sem reservas no momento.
                    </div>
                {{/if}}
            </div>
        </div>
    </div>
</main>
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="toastConfirmarDelete" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-warning text-dark">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong class="me-auto">Confirmação</strong>
            <button type="button" class="btn text-dark p-0" data-bs-dismiss="toast" aria-label="Fechar" style="margin-left: 10rem;">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div class="toast-body">
            Tem certeza que deseja inativar este item?
            <div class="mt-2 pt-2 border-top d-flex justify-content-end gap-2">
                <button type="button" class="btn btn-sm btn-secondary" data-bs-dismiss="toast">Cancelar</button>
                <form id="formDelete" method="POST">
                    <button type="submit" class="btn btn-sm btn-danger">Inativar</button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
  function confirmarApagar(url) {
    const form = document.getElementById('formDelete');
    form.action = url;

    const toastEl = document.getElementById('toastConfirmarDelete');
    const toast = new bootstrap.Toast(toastEl);
    toast.show();
  }
</script>

<script>
    function copiarEntrada(){
        const dt_planejada = document.getElementById("dt_planejada");
        let dt_planejadafinal = document.getElementById("dt_planejadafinal");
        
        let copia = dt_planejada.value;
        dt_planejadafinal.value = copia;
    }
</script>

<script>
function verificarConflitoReserva() {
    const dtInicio = new Date(document.getElementById("dt_planejada").value);
    const dtFim = new Date(document.getElementById("dt_planejadafinal").value);

    if (!dtInicio || !dtFim || isNaN(dtInicio.getTime()) || isNaN(dtFim.getTime())) {
        alert("Preencha corretamente as datas de início e fim.");
        return;
    }

    if (dtFim <= dtInicio) {
        alert("A data final deve ser maior que a data de início.");
        return;
    }

    const cards = document.querySelectorAll('.card');
    let conflito = false;

    cards.forEach(card => {
        const dtReservaInicioStr = card.querySelector('#card_dt_planejada').innerText.trim();
        const dtReservaFimStr = card.querySelector('#card_dt_planejadafinal').innerText.trim();

        const dtReservaInicio = parseDataBRParaDate(dtReservaInicioStr);
        const dtReservaFim = parseDataBRParaDate(dtReservaFimStr);

        if (!dtReservaInicio || !dtReservaFim) return;

        if ((dtInicio < dtReservaFim) && (dtFim > dtReservaInicio)) {
            conflito = true;
        }
    });

    if (conflito) {
        alert("Já existe uma reserva nesse período!");
        return;
    }

    document.querySelector("form").submit();
}

// Converte "29/10/2025 08:00" em um objeto Date válido
function parseDataBRParaDate(dataStr) {
    const [data, hora] = dataStr.split(' ');
    if (!data || !hora) return null;

    const [dia, mes, ano] = data.split('/').map(Number);
    const [horaPart, minutoPart] = hora.split(':').map(Number);

    return new Date(ano, mes - 1, dia, horaPart, minutoPart);
}
</script>




